name: Staged deploy to Test and Preprod

on:
  push:
    branches: [main]

jobs:
  code-tests:
    uses: "./.github/workflows/reusable-tests.yml"

  build:
    needs: code-tests
    uses: "./.github/workflows/reusable-build.yml"
    with:
      ecr_repository: $${{vars.TEST_ECR_REPOSITORY}}

  deploy-test:
    uses: "./.github/workflows/reusable-deploy.yml"
    needs: build
    with:
      env: "test"
      ecr_repository: ${{vars.TEST_ECR_REPOSITORY}}
    secrets:
      kube_namespace: ${{ secrets.KUBE_NAMESPACE }}
      kube_cert: ${{ secrets.KUBE_CERT }}
      kube_cluster: ${{ secrets.KUBE_CLUSTER }}
      kube_token: ${{ secrets.KUBE_TOKEN }}
      ecr_role_to_assume: ${{ secrets.TEST_ECR_ROLE_TO_ASSUME }}
      secret_key: ${{ secrets.SECRET_KEY }}
      catalogue_token: ${{ secrets.CATALOGUE_TOKEN }}
      slack_alert_webhook: ${{ secrets.SLACK_ALERT_WEBHOOK }}
      azure_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  promote-test:
    needs: deploy-test
    uses: "./.github/workflows/reusable-promote.yml"
    with:
      from_repository: ${{vars.TEST_ECR_REPOSITORY}}
      to_repository: ${{vars.PREPROD_ECR_REPOSITORY}}

  deploy-preprod:
    uses: "./.github/workflows/reusable-deploy.yml"
    needs: promote-test
    with:
      env: "preprod"
      ecr_repository: ${{vars.PREPROD_ECR_REPOSITORY}}
    secrets:
      kube_namespace: ${{ secrets.KUBE_NAMESPACE }}
      kube_cert: ${{ secrets.KUBE_CERT }}
      kube_cluster: ${{ secrets.KUBE_CLUSTER }}
      kube_token: ${{ secrets.KUBE_TOKEN }}
      ecr_role_to_assume: ${{ secrets.PREPROD_ECR_ROLE_TO_ASSUME }}
      secret_key: ${{ secrets.SECRET_KEY }}
      catalogue_token: ${{ secrets.CATALOGUE_TOKEN }}
      slack_alert_webhook: ${{ secrets.SLACK_ALERT_WEBHOOK }}
      azure_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  promote-preprod:
    needs: deploy-preprod
    uses: "./.github/workflows/reusable-promote.yml"
    with:
      from_repository: ${{vars.PREPROD_ECR_REPOSITORY}}
      to_repository: ${{vars.PROD_ECR_REPOSITORY}}
